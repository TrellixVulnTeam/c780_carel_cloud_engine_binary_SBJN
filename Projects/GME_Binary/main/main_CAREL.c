/*
  File  : main_carel.c

  Scope :
  this is ONLY an example of the flow request to make a
  functional system based on the Carel Cloud Library.
  Some routine could be called as a task if an
  operating system is available.
  In case the OS is not available is possible to use the
  routine in a mega-loop but take care that the system are
  able to run without significat jitter.

  Note  :

*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "data_types_CAREL.h"
#include "File_System_IS.h"
#include "RTC_IS.h"
#include "modbus_IS.h"
#include "binary_model.h"
#include "utilities.h"

#include "sys.h"

// related to the device (ESP32)
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "mb_m.h"
#include "gme_types.h"
#include "wifi.h"
#include "poll_engine.h"

//#include "CBOR_CAREL.h"
#include "MQTT_Interface_CAREL.h"

#ifdef IS_A_GSM_GATEWAY
#include "GSM_Miscellaneous_IS.h"
#endif

#ifdef IS_A_WIFI_GATEWAY

#endif


#define CAREL_CHECK(res, field)  (res == C_TRUE ? printf("OK %s\n", field) : printf("FAIL %s\n", field))

/* Functions implementation -------------------------------------------------------*/

static C_RES retval;
static gme_sm_t sm;



void Carel_Main_Task(void);


void app_main(void)  // main_Carel
{
  //retval = Init_RTC();

  /*
  if (retval != C_SUCCESS)
  {


  }
  */

  xTaskCreate(Carel_Main_Task, "Carel_Task", 3*CONFIG_SYSTEM_EVENT_TASK_STACK_SIZE, NULL, tskIDLE_PRIORITY, NULL );

}

void Carel_Main_Task(void)
{
	printf("\nFIRMWARE VERSION %d.%d.%d\r\n\n",FW_VER_XX,FW_VER_YY,FW_VER_ZZ);
#if 0
		//size_t buflen=500;
		//size_t len;
		//uint8_t buf[]={0xA4,0x63,0x76,0x65,0x72,0x18,0x64,0x63,0x72,0x74,0x6F,0x78,0x25,0x61,0x63,0x6D,0x65,0x2F,0x35,0x33,0x42,0x43,0x45,0x34,0x46,0x31,0x44,0x46,0x41,0x30,0x46,0x45,0x38,0x45,0x37,0x43,0x41,0x31,0x32,0x36,0x46,0x39,0x31,0x42,0x33,0x35,0x44,0x33,0x41,0x36,0x63,0x63,0x6D,0x64,0x01,0x63,0x62,0x61,0x75,0x19,0x4B,0x00};
		//int i;
		//set_gw_config reversed order
		//uint8_t buf[]={0xA8,0x63,0x76,0x65,0x72,0x18,0x65,0x63,0x72,0x74,0x6F,0x67,0x61,0x63,0x6D,0x65,0x2F,0x35,0x33,0x63,0x70,0x76,0x61,0x19,0x02,0x58,0x63,0x63,0x6D,0x64,0x01,0x63,0x70,0x73,0x74,0x19,0x01,0x2C,0x63,0x6D,0x6B,0x61,0x18,0x3C,0x63,0x6C,0x73,0x73,0x19,0x02,0x58,0x63,0x68,0x73,0x73,0x19,0x01,0x2C};
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x61,0x78,0x63,0x63,0x6D,0x64,0x07,0x63,0x61,0x6C,0x69,0x62,0x33,0x34,0x63,0x66,0x75,0x6E,0x01,0x63,0x61,0x64,0x72,0x02,0x63,0x64,0x69,0x6D,0x10,0x63,0x70,0x6F,0x73,0x01,0x63,0x6C,0x65,0x6E,0x04,0x61,0x61,0x63,0x31,0x2E,0x30,0x61,0x62,0x63,0x30,0x2E,0x30,0x63,0x66,0x6C,0x67,0x00,0x63,0x76,0x61,0x6C,0x70,0x31,0x32,0x33,0x34,0x35,0x2E,0x36,0x37,0x38,0x39,0x30,0x31,0x32,0x33,0x34,0x35,0xFF};
		//change credentials
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x72,0x63,0x68,0x61,0x6E,0x67,0x65,0x2D,0x63,0x72,0x65,0x64,0x65,0x6E,0x74,0x69,0x61,0x6C,0x73,0x63,0x63,0x6D,0x64,0x10,0x63,0x75,0x73,0x72,0x65,0x5F,0x75,0x73,0x65,0x72,0x63,0x70,0x77,0x64,0x64,0x5F,0x70,0x77,0x64,0xFF};
		//set_line_config
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x74,0x72,0x65,0x73,0x2F,0x73,0x65,0x74,0x5F,0x6C,0x69,0x6E,0x65,0x73,0x5F,0x63,0x6F,0x6E,0x66,0x69,0x67,0x63,0x63,0x6D,0x64,0x04,0x63,0x62,0x61,0x75,0x1A,0x00,0x01,0xC2,0x00,0x63,0x63,0x6F,0x6E,0x01,0xFF};
		//scan devices
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x6D,0x72,0x65,0x73,0x2F,0x73,0x63,0x61,0x6E,0x5F,0x6C,0x69,0x6E,0x65,0x63,0x63,0x6D,0x64,0x03,0x63,0x6C,0x69,0x64,0x01,0xFF};
		//set_gw_config
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x71,0x72,0x65,0x73,0x2F,0x73,0x65,0x74,0x5F,0x67,0x77,0x5F,0x63,0x6F,0x6E,0x66,0x69,0x67,0x63,0x63,0x6D,0x64,0x01,0x63,0x70,0x76,0x61,0x19,0x02,0x58,0x63,0x70,0x73,0x74,0x19,0x01,0x2C,0x63,0x6D,0x6B,0x61,0x18,0x3C,0x63,0x6C,0x73,0x73,0x19,0x02,0x58,0x63,0x68,0x73,0x73,0x19,0x01,0x2C,0xFF};
		//set_devs_config
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x78,0x18,0x72,0x65,0x73,0x2F,0x64,0x6F,0x77,0x6E,0x6C,0x6F,0x61,0x64,0x5F,0x64,0x65,0x76,0x73,0x5F,0x63,0x6F,0x6E,0x66,0x69,0x67,0x63,0x63,0x6D,0x64,0x05,0x63,0x75,0x73,0x72,0x66,0x5F,0x75,0x73,0x65,0x72,0x5F,0x63,0x70,0x77,0x64,0x6A,0x5F,0x70,0x61,0x73,0x73,0x77,0x6F,0x72,0x64,0x5F,0x63,0x75,0x72,0x69,0x78,0x2B,0x68,0x74,0x74,0x70,0x73,0x3A,0x2F,0x2F,0x31,0x2E,0x31,0x2E,0x31,0x2E,0x31,0x2F,0x64,0x6F,0x77,0x6E,0x6C,0x6F,0x61,0x64,0x5F,0x64,0x65,0x76,0x73,0x5F,0x63,0x6F,0x6E,0x66,0x69,0x67,0x2F,0x67,0x6D,0x65,0x2D,0x30,0x32,0x63,0x63,0x69,0x64,0x1A,0x00,0x01,0x00,0x00,0xFF};
		//update_dev_fw
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x77,0x72,0x65,0x73,0x2F,0x75,0x70,0x64,0x61,0x74,0x65,0x5F,0x64,0x65,0x76,0x5F,0x66,0x69,0x72,0x6D,0x77,0x61,0x72,0x65,0x63,0x63,0x6D,0x64,0x0B,0x63,0x75,0x73,0x72,0x66,0x5F,0x75,0x73,0x65,0x72,0x5F,0x63,0x70,0x77,0x64,0x6A,0x5F,0x70,0x61,0x73,0x73,0x77,0x6F,0x72,0x64,0x5F,0x63,0x75,0x72,0x69,0x78,0x2A,0x68,0x74,0x74,0x70,0x73,0x3A,0x2F,0x2F,0x31,0x2E,0x31,0x2E,0x31,0x2E,0x31,0x2F,0x75,0x70,0x64,0x61,0x74,0x65,0x5F,0x64,0x65,0x76,0x5F,0x66,0x69,0x72,0x6D,0x77,0x61,0x72,0x65,0x2F,0x67,0x6D,0x65,0x2D,0x30,0x32,0x63,0x66,0x69,0x64,0x19,0xFF,0xFF,0x63,0x77,0x65,0x74,0x19,0x80,0x00,0xFF};
		//reboot
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x6A,0x72,0x65,0x73,0x2F,0x72,0x65,0x62,0x6F,0x6F,0x74,0x63,0x63,0x6D,0x64,0x02,0x63,0x63,0x69,0x64,0x1A,0x00,0x01,0x00,0x00,0xFF};
		//write_variables
		uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x61,0x78,0x63,0x63,0x6D,0x64,0x07,0x63,0x61,0x6C,0x69,0x62,0x33,0x34,0x63,0x66,0x75,0x6E,0x10,0x63,0x61,0x64,0x72,0x02,0x63,0x64,0x69,0x6D,0x10,0x63,0x70,0x6F,0x73,0x01,0x63,0x6C,0x65,0x6E,0x04,0x61,0x61,0x63,0x31,0x2E,0x30,0x61,0x62,0x63,0x30,0x2E,0x30,0x63,0x66,0x6C,0x67,0x00,0x63,0x76,0x61,0x6C,0x70,0x31,0x32,0x33,0x34,0x35,0x2E,0x36,0x37,0x38,0x39,0x30,0x31,0x32,0x33,0x34,0x35,0xFF};
		//read_variables
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x61,0x78,0x63,0x63,0x6D,0x64,0x06,0x63,0x61,0x6C,0x69,0x62,0x33,0x34,0x63,0x66,0x75,0x6E,0x01,0x63,0x61,0x64,0x72,0x02,0x63,0x64,0x69,0x6D,0x10,0x63,0x70,0x6F,0x73,0x01,0x63,0x6C,0x65,0x6E,0x04,0x61,0x61,0x63,0x31,0x2E,0x30,0x61,0x62,0x63,0x30,0x2E,0x30,0x63,0x66,0x6C,0x67,0x00,0xFF};
		//stop_engine
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x6F,0x72,0x65,0x73,0x2F,0x73,0x74,0x6F,0x70,0x5F,0x65,0x6E,0x67,0x69,0x6E,0x65,0x63,0x63,0x6D,0x64,0x11,0xFF};
		//start_engine
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x70,0x72,0x65,0x73,0x2F,0x73,0x74,0x61,0x72,0x74,0x5F,0x65,0x6E,0x67,0x69,0x6E,0x65,0x63,0x63,0x6D,0x64,0x10,0xFF};
		//send_mb_adu
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x76,0x72,0x65,0x73,0x2F,0x73,0x65,0x6E,0x64,0x5F,0x6D,0x64,0x5F,0x61,0x64,0x75,0x2F,0x67,0x6D,0x65,0x2D,0x30,0x32,0x63,0x63,0x6D,0x64,0x0E,0x63,0x73,0x65,0x71,0x0A,0x63,0x61,0x64,0x75,0x6C,0x41,0x51,0x4D,0x41,0x41,0x51,0x41,0x42,0x71,0x72,0x73,0x3D,0xFF};
		//flush_values
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x76,0x72,0x65,0x73,0x2F,0x73,0x65,0x6E,0x64,0x5F,0x6D,0x64,0x5F,0x61,0x64,0x75,0x2F,0x67,0x6D,0x65,0x2D,0x30,0x32,0x63,0x63,0x6D,0x64,0x0C,0xFF};
		//send_mb_pass_through
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x78,0x1F,0x72,0x65,0x73,0x2F,0x73,0x65,0x6E,0x64,0x5F,0x6D,0x64,0x5F,0x70,0x61,0x73,0x73,0x5F,0x74,0x68,0x72,0x6F,0x75,0x67,0x68,0x2F,0x67,0x6D,0x65,0x2D,0x30,0x32,0x63,0x63,0x6D,0x64,0x0F,0x63,0x70,0x61,0x73,0x03,0xFF};
		//update_ca
		//uint8_t buf[]={0xBF,0x63,0x76,0x65,0x72,0x19,0x01,0x01,0x63,0x72,0x74,0x6F,0x6D,0x72,0x65,0x73,0x2F,0x75,0x70,0x64,0x61,0x74,0x65,0x5F,0x63,0x61,0x63,0x63,0x6D,0x64,0x0D,0x63,0x75,0x73,0x72,0x66,0x5F,0x75,0x73,0x65,0x72,0x5F,0x63,0x70,0x77,0x64,0x6A,0x5F,0x70,0x61,0x73,0x73,0x77,0x6F,0x72,0x64,0x5F,0x63,0x75,0x72,0x69,0x78,0x20,0x68,0x74,0x74,0x70,0x73,0x3A,0x2F,0x2F,0x31,0x2E,0x31,0x2E,0x31,0x2E,0x31,0x2F,0x75,0x70,0x64,0x61,0x74,0x65,0x5F,0x63,0x61,0x2F,0x67,0x6D,0x65,0x2D,0x30,0x32,0xFF};
		CBOR_ReqTopicParser(buf,sizeof(buf));


#endif

  while(1)
  {
	  switch (sm)
	  {
		  //System Initialization
		  case GME_INIT:
		  {
			  retval = Sys__Init();								// RELATED TO ESP32 BOARD
			  CAREL_CHECK(retval, "SYSTEM");

			  sm = GME_CONFIG;
			  break;
		  }
		  //Start and configure WiFi interface
		  case GME_CONFIG:
		  {
			  uint8_t config_status;
			  config_status = Sys__Config(Sys_GetConfigSM());  // RELATED TO ESP32 BOARD

			  if(GME_REBOOT == config_status){
				  sm = GME_REBOOT;
			  }
			  else if(GME_STRAT_SYS == config_status){
				  sm = GME_STRAT_SYS;
			  }

			  break;
		  }
          //Starting the main functionalities of the GME
          case GME_STRAT_SYS:
          {
          	WiFi__WaitConnection();                         // RELATED TO ESP32 BOARD

          	// following call should have parameterized args
          	retval = RTC_Init("pool.ntp.org", 123);							// Carel
          	CAREL_CHECK(retval, "TIME");

          	Utilities__Init();								// da capire se CAREL o ESP32

  			MQTT_Start();


          	sm = GME_START_POLLING_ENGINE;

  			break;
          }
          case GME_START_POLLING_ENGINE:
          {
          	if(1){    // MQTT_GetFlags().init == 1

          	    retval = BinaryModel_Init();		// CAREL
          	    CAREL_CHECK(retval, "MODEL");

          	    retval = Modbus_Init(19200);        // CAREL
          	    CAREL_CHECK(retval, "UART");

          	    vTaskDelay(1000 / portTICK_PERIOD_MS);

          	    Modbus_Task_Start();                // CAREL
          	    vTaskDelay(1000 / portTICK_PERIOD_MS);

          	    CarelEngineMB_Init();				// CAREL


  				sm = GME_IDLE;
  			}else{
  				sm = GME_START_POLLING_ENGINE;
  			}

  			break;
          }


          case GME_IDLE:
          	//TODO
              WiFi__WaitConnection();
/*
              if(MQTT__GetFlags().init == 1){
              	MQTT_PeriodicTasks();			// manage the MQTT subscribes
             }
*/
              //If we received a new WiFi configuration during system running (Re-Configure)
              if(IsConfigReceived()){
              	sm = GME_CONFIG;
              	Sys_SetConfigSM(WAITING_FOR_HTML_CONF_PARAMETERS);
              }
              break;


          //Reboot ESP after 5 seconds
          case GME_REBOOT:
          	for(int i=5; i>0; i--)
          	{
          		printf("Rebooting after %d sec ...\n",i);
          		vTaskDelay(1000/portTICK_RATE_MS);
          	}
              printf("Rebooting now ...\n");
              fflush(stdout);
              esp_restart();

              break;

          default:
              break;
          }

          //If the factory reset button has been pressed for X time (look gme_config.h)
          if(true == Sys__ResetCheck())
          {
          	printf("RESET CHECK DONE STATEMACHINE\n");
          	sm = GME_REBOOT;
          }
      }







  //vTaskDelay(1000 / portTICK_PERIOD_MS);

  //xTaskCreate(&Modbus_rw_test, "MODBUS_TEST", 2*1024, NULL, 4, NULL);



  /*for(;;)
  {
	  //printf("in main loop every 5sec\n");
	  //printf("valore letto %d, %d\n", test_value[0], test_value[1]);

	  vTaskDelay(5000 / portTICK_PERIOD_MS);
  }
*/



}











